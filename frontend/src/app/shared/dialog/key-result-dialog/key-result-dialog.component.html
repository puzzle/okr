<div mat-dialog-content class="dialog dialog-padding">
  <app-dialog-header
    [dialogTitle]="data.keyResult ? 'Key Result bearbeiten' : 'Key Result erfassen'"
  ></app-dialog-header>
  <form (ngSubmit)="saveKeyResult()" [formGroup]="keyResultForm" class="d-flex flex-column flex-wrap container p-0">
    <div class="d-flex flex-column gap-2 col-12">
      <label for="title" class="text-black">Titel</label>
      <textarea
        [attr.data-testId]="'titleInput'"
        [ngClass]="formInputCheck(keyResultForm, 'title')"
        class="input-fields big-dialog-form-field"
        formControlName="title"
        id="title"
        cdkFocusInitial
      ></textarea>
      <span *ngIf="isTouchedOrDirty('title')">
        <mat-error *ngFor="let errorKey of getErrorKeysOfFormField('title')">
          <span>{{ errorMessages[errorKey.toUpperCase()] }}</span>
        </mat-error>
      </span>
    </div>

    <div class="mt-2">
      <app-keyresult-type [keyresult]="data.keyResult" [keyResultForm]="keyResultForm"></app-keyresult-type>
    </div>

    <div class="d-flex flex-column gap-2 col-12">
      <label>Owner</label>
      <input
        (keydown.enter)="$event.preventDefault()"
        [ngClass]="invalidOwner() ? 'dialog-form-field-error' : 'dialog-form-field'"
        class="input-fields owner-input"
        [attr.data-testId]="'ownerInput'"
        [matAutocomplete]="auto"
        formControlName="owner"
      />
      <mat-autocomplete #auto="matAutocomplete" [displayWith]="getUserNameById.bind(this)">
        <mat-option *ngFor="let user of filteredUsers$ | async" [value]="user">
          {{ user.firstname + " " + user.lastname }}
        </mat-option>
      </mat-autocomplete>
      <div *ngIf="invalidOwner()">
        <mat-error>Du musst einen Owner auswählen</mat-error>
      </div>
    </div>

    <div class="d-flex flex-column gap-2 col-12">
      <label for="title" class="text-black">Beschreibung (optional)</label>
      <textarea
        [attr.data-testId]="'descriptionInput'"
        class="input-fields big-dialog-form-field"
        [ngClass]="formInputCheck(keyResultForm, 'description')"
        formControlName="description"
      ></textarea>
      <div *ngIf="isTouchedOrDirty('description')">
        <mat-error *ngFor="let errorKey of getErrorKeysOfFormField('description')">
          <span>{{ errorMessages[errorKey.toUpperCase()] }}</span>
        </mat-error>
      </div>
    </div>
  </form>

  <app-action-plan [control]="keyResultForm.controls.actionList"></app-action-plan>

  <div class="d-flex justify-content-between p-0" mat-dialog-actions>
    <span>
      <button
        [attr.data-testId]="'submit'"
        type="submit"
        (click)="saveKeyResult()"
        [disabled]="keyResultForm.invalid || invalidOwner()"
        color="primary"
        mat-flat-button
      >
        Speichern
      </button>
      <button
        *ngIf="!data.keyResult"
        [attr.data-testId]="'saveAndNew'"
        (click)="openNew()"
        mat-stroked-button
        [disabled]="keyResultForm.invalid"
      >
        Speichern & Neu
      </button>
      <button mat-button mat-dialog-close color="primary">Abbrechen</button>
    </span>
    <button
      *ngIf="this.data.keyResult"
      [attr.data-testId]="'delete'"
      mat-button
      color="primary"
      (click)="deleteKeyResult()"
    >
      Key Result löschen
    </button>
  </div>
</div>
